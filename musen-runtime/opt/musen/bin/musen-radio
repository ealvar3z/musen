#!/usr/bin/env bash
# Purpose: Manage active radio profile selection.

set -euo pipefail

# shellcheck source=/opt/musen/bin/musen-common
source /opt/musen/bin/musen-common

ACTIVE_RADIO="${MUSEN_HOME}/conf/radios.d/active-radio.json"
NO_RADIO_ID="no-radio"

show_menu_dialog() {
  local -a items=("$@")
  dialog --clear --menu "Select a radio:" 22 72 12 "${items[@]}" 3>&1 1>&2 2>&3
}

show_menu_select() {
  local -a pairs=("$@")
  local -a item_ids=()
  local -a item_desc=()
  local i=0
  local choice=""

  for ((i=0; i<${#pairs[@]}; i+=2)); do
    item_ids+=("${pairs[i]}")
    item_desc+=("${pairs[i+1]}")
  done

  printf '\nSelect a radio:\n'
  select choice in "${item_desc[@]}"; do
    if [[ -n "${choice}" ]]; then
      printf '%s\n' "${item_ids[$((REPLY - 1))]}"
      return 0
    fi
    printf 'Invalid option.\n'
  done
}

set_active_radio() {
  local selected_radio="$1"
  local radio_conf=""
  local id=""
  local vendor=""
  local model=""

  if [[ "${selected_radio}" == "${NO_RADIO_ID}" ]]; then
    [[ -e "${ACTIVE_RADIO}" ]] && rm -f "${ACTIVE_RADIO}"
    printf 'Set active radio to: %s\n' "${selected_radio}"
    return 0
  fi

  radio_conf="${MUSEN_HOME}/conf/radios.d/${selected_radio}.json"
  if [[ ! -e "${radio_conf}" ]]; then
    printf '%sRadio config not found: %s%s\n' "${RED}" "${radio_conf}" "${NC}"
    return 1
  fi

  [[ -e "${ACTIVE_RADIO}" ]] && rm -f "${ACTIVE_RADIO}"
  ln -s "${radio_conf}" "${ACTIVE_RADIO}"
  printf 'Set active radio to: %s\n' "${selected_radio}"

  id="$(jq -r '.id' "${ACTIVE_RADIO}")"
  vendor="$(jq -r '.vendor' "${ACTIVE_RADIO}")"
  model="$(jq -r '.model' "${ACTIVE_RADIO}")"

  printf '%-20s %-14s %-16s\n' "Radio ID" "Vendor" "Model"
  printf '%-20s %-14s %-16s\n\n' "${id}" "${vendor}" "${model}"

  printf '%bRADIO CONFIGURATION NOTES%b\n' "${YELLOW}" "${NC}"
  jq -r '.notes[]? | "* \(.)"' "${ACTIVE_RADIO}" 2>/dev/null || true
  printf '\n'

  printf '%bREQUIRED ACTIONS%b\n' "${GREEN}" "${NC}"
  printf '1. Apply the settings above to your radio.\n'
  printf '2. Plug in the USB cable for your radio. If already connected, reconnect it.\n'
  printf "3. Run 'musen-mode' and select the desired mode.\n\n"
}

main() {
  local -a options=()
  local -a radio_files=()
  local selected_radio=""
  local id=""
  local vendor=""
  local model=""
  local menu_exit=0

  options+=("${NO_RADIO_ID}" "No radio")

  mapfile -t radio_files < <(find "${MUSEN_HOME}/conf/radios.d" -maxdepth 1 -type f -name '*.json' | sort)
  for radio_file in "${radio_files[@]}"; do
    if [[ "${radio_file}" == *"/active-radio.json" || "${radio_file}" == *".bt.json" ]]; then
      continue
    fi
    id="$(jq -r '.id // empty' "${radio_file}")"
    vendor="$(jq -r '.vendor // "Unknown"' "${radio_file}")"
    model="$(jq -r '.model // "Unknown"' "${radio_file}")"
    [[ -z "${id}" ]] && continue
    options+=("${id}" "${vendor} ${model}")
  done

  if command -v dialog >/dev/null 2>&1; then
    set +e
    selected_radio="$(show_menu_dialog "${options[@]}")"
    menu_exit=$?
    set -e
    tput sgr0 >/dev/null 2>&1 || true
    clear >/dev/null 2>&1 || true
  else
    selected_radio="$(show_menu_select "${options[@]}")"
    menu_exit=$?
  fi

  if (( menu_exit != 0 )) || [[ -z "${selected_radio}" ]]; then
    printf 'No radio selected.\n'
    exit 1
  fi

  set_active_radio "${selected_radio}"
}

main "$@"
