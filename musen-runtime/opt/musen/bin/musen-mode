#!/usr/bin/env bash
# Purpose: Configure and start a specific Musen operating mode.

set -euo pipefail

# shellcheck source=/opt/musen/bin/musen-common
source /opt/musen/bin/musen-common

MUSEN_MODE_FILE="${MUSEN_MODE_FILE:-${HOME}/.config/musen/mode}"
MUSEN_MODE_DIR="${MUSEN_MODE_FILE%/*}"

MODE_ID_NONE="none"
MODE_ID_PACKET_SIMPLE="packet-simple"
MODE_ID_WINLINK_PACKET="winlink-packet"
MODE_ID_WINLINK_ARDOP="winlink-ardop"

mkdir -p "${MUSEN_MODE_DIR}"

show_menu_dialog() {
  local -a items=("$@")
  dialog --clear --menu "Select a mode:" 16 72 10 "${items[@]}" 3>&1 1>&2 2>&3
}

show_menu_select() {
  local -a pairs=("$@")
  local -a mode_ids=()
  local -a mode_desc=()
  local idx=0
  local choice=""

  for ((idx=0; idx<${#pairs[@]}; idx+=2)); do
    mode_ids+=("${pairs[idx]}")
    mode_desc+=("${pairs[idx+1]}")
  done

  printf '\nSelect a mode:\n'
  select choice in "${mode_desc[@]}"; do
    if [[ -n "${choice}" ]]; then
      printf '%s\n' "${mode_ids[$((REPLY - 1))]}"
      return 0
    fi
    printf 'Invalid option.\n'
  done
}

start_mode() {
  local selected_mode="$1"

  case "${selected_mode}" in
    "${MODE_ID_NONE}")
      musen_log "No mode selected"
      ;;
    "${MODE_ID_PACKET_SIMPLE}")
      start_and_wait_for_service "musen-service-direwolf-simple.service"
      musen_log "Packet simple mode now running."
      ;;
    "${MODE_ID_WINLINK_PACKET}")
      start_and_wait_for_service "musen-service-direwolf-simple.service"
      start_and_wait_for_service "musen-service-winlink-packet.service"
      musen_log "Winlink packet mode now running."
      ;;
    "${MODE_ID_WINLINK_ARDOP}")
      start_and_wait_for_service "musen-service-ardop.service"
      start_and_wait_for_service "musen-service-winlink-ardop.service"
      musen_log "Winlink ARDOP mode now running."
      ;;
    *)
      musen_log "Mode '${selected_mode}' is not supported."
      return 1
      ;;
  esac
}

main() {
  local -a options=(
    "${MODE_ID_NONE}" "No mode selected"
    "${MODE_ID_PACKET_SIMPLE}" "Packet (Direwolf simple)"
    "${MODE_ID_WINLINK_PACKET}" "Winlink over packet"
    "${MODE_ID_WINLINK_ARDOP}" "Winlink over ARDOP"
  )
  local selected_mode=""
  local menu_exit=0

  if command -v dialog >/dev/null 2>&1; then
    set +e
    selected_mode="$(show_menu_dialog "${options[@]}")"
    menu_exit=$?
    set -e
    tput sgr0 >/dev/null 2>&1 || true
    clear >/dev/null 2>&1 || true
  else
    selected_mode="$(show_menu_select "${options[@]}")"
    menu_exit=$?
  fi

  if (( menu_exit != 0 )) || [[ -z "${selected_mode}" ]]; then
    musen_log "No mode selected"
    printf '%s\n' "${MODE_ID_NONE}" > "${MUSEN_MODE_FILE}"
    exit 1
  fi

  musen-kill-all || true
  printf '%s\n' "${selected_mode}" > "${MUSEN_MODE_FILE}"

  start_mode "${selected_mode}"
}

main "$@"
